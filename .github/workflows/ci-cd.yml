name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run backend tests
      run: |
        cd backend
        mvn clean test
        
    - name: Generate test report
      run: |
        cd backend
        mvn surefire-report:report
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: backend/target/surefire-reports/

  build-test:
    name: Build and Test Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
        
    - name: Build unified backend image (includes frontend)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.backend
        push: false
        tags: qa-automation-hub:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Test Docker image
      run: |
        echo "Testing Docker image build..."
        docker images qa-automation-hub:test

  deploy-staging:
    name: Deploy to Railway Staging
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Railway Deployment Check
      run: |
        echo "ðŸš€ Railway Deployment Status"
        echo "============================="
        echo "âœ… Railway GitHub Integration Active"
        echo "âœ… Single-service architecture (Backend + Frontend)"
        echo "âœ… Automatic deployment on push to main"
        echo ""
        echo "Deployment URL: https://passionate-communication-production-da98.up.railway.app"
        echo "Health Check: https://passionate-communication-production-da98.up.railway.app/actuator/health"
        echo "Dashboard: https://passionate-communication-production-da98.up.railway.app/test-dashboard.html"
        echo ""
        echo "âœ… CI/CD Pipeline: Simplified and optimized"
        echo "âœ… Tests: Passed"
        echo "âœ… Build: Successful"
        echo "âœ… Deployment: Automatic via Railway"
        echo ""
        echo "No manual deployment needed - Railway handles it automatically!"